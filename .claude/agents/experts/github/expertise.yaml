# GitHub Workflow Expertise
# Target: 400-600 lines | Warning: 800 | Hard limit: 1000
# Domain: Operational knowledge for GitHub workflows, PR labels, and CI/CD automation

overview:
  description: |
    GitHub workflow management for agentic-test—issue classification and lifecycle, pull request
    creation with validation levels, branch naming conventions, CI/CD automation, and PR labels.
    This expertise enables correct GitHub operations within the project conventions.
  scope: |
    Covers GitHub issue management (classification, labeling, prioritization), pull request
    workflows (creation, validation levels, review process), branch naming conventions,
    CI/CD automation (12 workflows), and PR label taxonomy (29 labels).

    Does NOT cover Claude Code configuration (see claude-config expert) or agent authoring
    (see agent-authoring expert).
  rationale: |
    Consistent GitHub workflows enable predictable issue tracking, code review, and release
    management. The project has established conventions that differ from generic GitHub workflows.

# ─────────────────────────────────────────────────────────────────────────────
# PR LABELS - All 29 labels organized by category
# ─────────────────────────────────────────────────────────────────────────────
pr_labels:
  type:
    bug:
      purpose: Something isn't working
      color: d73a4a
      applied_by: triage-issue workflow, manual
      triggers: auto-implement when combined with auto-implement label
    feature:
      purpose: New feature or enhancement
      color: a2eeef
      applied_by: triage-issue workflow, manual
      triggers: auto-implement when combined with auto-implement label
    chore:
      purpose: Maintenance, refactoring, or infrastructure
      color: fef2c0
      applied_by: triage-issue workflow, manual
      triggers: auto-implement when combined with auto-implement label

  confidence:
    confidence:high:
      purpose: High confidence for auto-implementation
      color: "0e8a16"
      applied_by: triage-issue workflow (assess-confidence)
      triggers: auto-implement.yml (when combined with auto-implement)
    confidence:medium:
      purpose: Medium confidence, needs review
      color: fbca04
      applied_by: triage-issue workflow (assess-confidence)
      triggers: auto-implement.yml (when combined with auto-implement)
    confidence:low:
      purpose: Low confidence, requires human review
      color: e99695
      applied_by: triage-issue workflow (assess-confidence)
      triggers: none (blocks auto-implementation)

  workflow:
    auto-implement:
      purpose: Automatically implement this issue
      color: "0e8a16"
      applied_by: triage-issue workflow (high/medium confidence), manual
      triggers: auto-implement.yml
    needs-review:
      purpose: Requires human review before proceeding
      color: fbca04
      applied_by: issue-opened failure handler, manual
      triggers: none (blocks automation)
    needs-info:
      purpose: More information needed from reporter
      color: d876e3
      applied_by: triage-issue workflow, manual
      triggers: none
    needs-breakdown:
      purpose: Issue is too large, needs to be broken down
      color: f9d0c4
      applied_by: triage-issue workflow, manual
      triggers: none
    has-dependencies:
      purpose: Blocked by or depends on other issues
      color: c5def5
      applied_by: manual
      triggers: none

  phase:
    phase:tests:
      purpose: TDD red phase - writing tests first
      color: "0e8a16"
      applied_by: auto-implement.yml after draft PR created
      triggers: auto-implement-phases.yml (write-tests job)
    phase:implement:
      purpose: TDD green phase - implementing to pass tests
      color: fbca04
      applied_by: auto-implement-phases.yml after tests written
      triggers: auto-implement-phases.yml (implement job)
    phase:finalize:
      purpose: Documentation and cleanup phase
      color: "1d76db"
      applied_by: auto-implement-phases.yml after implementation
      triggers: auto-implement-phases.yml (finalize job)
    phase:complete:
      purpose: All phases completed successfully
      color: "0e8a16"
      applied_by: auto-implement-phases.yml after finalize
      triggers: none (terminal state)
    phase:failed:
      purpose: Phase failed, requires retry or intervention
      color: b60205
      applied_by: auto-implement-phases.yml on failure
      triggers: none (requires manual intervention)

  review:
    review:done:
      purpose: Peer review approved
      color: "0e8a16"
      applied_by: claude-code-review.yml on APPROVED
      triggers: none
    review:needs-work:
      purpose: Peer review requested changes
      color: e99695
      applied_by: claude-code-review.yml on CHANGES_REQUESTED
      triggers: review-fix.yml (for auto-implement branches)

  priority:
    P1:
      purpose: Critical priority
      color: b60205
      applied_by: manual
      triggers: none
    P2:
      purpose: High priority
      color: d93f0b
      applied_by: manual
      triggers: none
    P3:
      purpose: Normal priority
      color: "0e8a16"
      applied_by: manual
      triggers: none

  scope:
    client:
      purpose: Affects client workspace
      color: 1d76db
      applied_by: manual
      triggers: none
    server:
      purpose: Affects server workspace
      color: "5319e7"
      applied_by: manual
      triggers: none
    shared:
      purpose: Affects shared workspace
      color: "006b75"
      applied_by: manual
      triggers: none

  infrastructure:
    dependencies:
      purpose: Dependency updates
      color: 0366d6
      applied_by: dependabot, manual
      triggers: none
    ci-cd:
      purpose: CI/CD changes
      color: bfd4f2
      applied_by: manual
      triggers: none
    workflow-test-failure:
      purpose: Workflow smoke test failure
      color: b60205
      applied_by: workflow-smoke-test.yml on failure
      triggers: none

# ─────────────────────────────────────────────────────────────────────────────
# WORKFLOWS - All 12 workflows organized by trigger type
# ─────────────────────────────────────────────────────────────────────────────
workflows:
  issue_triggers:
    issue-opened.yml:
      name: Issue Opened - Triage & Auto-Implement Assessment
      trigger: issues.opened
      guard: github.event.issue.user.login == 'Pierre-Mike'
      purpose: Triage new issues, classify type, assess confidence, apply labels
      labels_applied: [type labels, confidence labels, auto-implement or needs-review]
      labels_removed: []
      failure_behavior: Applies needs-review label, posts failure comment

    auto-implement.yml:
      name: Auto Implement Issue
      trigger: issues.labeled
      guard: |
        label is auto-implement/confidence:high/confidence:medium AND
        issue has auto-implement label AND user is Pierre-Mike
      purpose: Create spec/plan, create draft PR, start TDD workflow
      labels_applied: [phase:tests]
      labels_removed: []
      creates: Draft PR with issue-{number}-auto-implement branch

  pr_triggers:
    auto-implement-phases.yml:
      name: Auto Implement Phases
      trigger: pull_request.labeled
      guard: branch matches issue-*-auto-implement pattern
      purpose: Execute TDD phases (tests → implement → finalize)
      jobs:
        write-tests:
          trigger_label: phase:tests
          labels_applied: [phase:implement]
          labels_removed: [phase:tests]
        implement:
          trigger_label: phase:implement
          labels_applied: [phase:finalize]
          labels_removed: [phase:implement]
        finalize:
          trigger_label: phase:finalize
          labels_applied: [phase:complete]
          labels_removed: [phase:finalize]
          actions: Marks PR ready for review
      failure_behavior: Applies phase:failed, posts retry instructions

    claude-code-review.yml:
      name: Claude Peer Review
      trigger: pull_request.opened/synchronize/ready_for_review/reopened
      guard: PR is not draft
      purpose: Automated peer review using Claude Code
      labels_applied: [review:done OR review:needs-work]
      labels_removed: [opposite review label]

    review-fix.yml:
      name: Review Fix Loop
      trigger: pull_request.labeled
      guard: |
        label is review:needs-work AND
        branch matches issue-*-auto-implement pattern
      purpose: Automatically fix review comments (max 3 attempts)
      labels_applied: []
      labels_removed: [review:needs-work]
      failure_behavior: Stops after 3 attempts, requires manual intervention

    deploy-preview.yml:
      name: Deploy Preview
      trigger: pull_request.opened/synchronize/reopened
      guard: PR is not draft AND changes in client/server/shared
      purpose: Deploy preview to Cloudflare Worker + GitHub Pages
      labels_applied: []
      labels_removed: []
      creates: Preview deployment comment

    cleanup-preview.yml:
      name: Cleanup Preview
      trigger: pull_request.closed
      guard: none
      purpose: Delete Cloudflare Worker and gh-pages preview directory
      labels_applied: []
      labels_removed: []

    auto-close-issues.yml:
      name: Auto Close Issues
      trigger: pull_request.closed
      guard: PR was merged
      purpose: Close issues linked via Closes/Fixes/Resolves keywords
      labels_applied: []
      labels_removed: []

  push_triggers:
    ci.yml:
      name: CI
      trigger: push to main/development OR pull_request to main/development
      guard: push always runs; PR skips drafts
      purpose: Run lint, type-check, test, build, security (CodeQL)
      jobs: [install, lint, type-check, test, build, security, ci-complete]

    deploy-production.yml:
      name: Deploy Production
      trigger: push to main (when client/server/shared changed) OR workflow_dispatch
      guard: changes in client/server/shared paths
      purpose: Deploy to production (Cloudflare Worker + GitHub Pages)
      creates: Production deployment

  comment_triggers:
    claude.yml:
      name: Claude Code
      trigger: |
        issue_comment.created OR pull_request_review_comment.created OR
        issues.opened/assigned OR pull_request_review.submitted
      guard: Comment/body/title contains @claude
      purpose: Respond to @claude mentions with Claude Code

  scheduled:
    workflow-smoke-test.yml:
      name: Workflow Smoke Test
      trigger: schedule (daily 8:00 UTC) OR workflow_dispatch
      guard: none
      purpose: End-to-end test of auto-implement workflow
      labels_applied: [workflow-test-failure, bug] on failure
      creates: Failure issue if test fails, closes on success

# ─────────────────────────────────────────────────────────────────────────────
# DECISION TREES
# ─────────────────────────────────────────────────────────────────────────────
decision_trees:
  label_selection:
    question: What label should I apply to this issue/PR?
    options:
      - if: New issue needs classification
        then: |
          Apply type label: bug (broken behavior), feature (new capability), chore (maintenance)
          Apply confidence label based on complexity assessment
          Apply auto-implement if confidence:high or confidence:medium
      - if: PR needs review status
        then: review:done (approved) or review:needs-work (changes requested)
      - if: Auto-implement PR phase tracking
        then: phase:tests → phase:implement → phase:finalize → phase:complete
      - if: Issue is blocked or depends on others
        then: has-dependencies
      - if: Issue needs more information
        then: needs-info
      - if: Issue is too large
        then: needs-breakdown

  workflow_trigger_map:
    question: Which workflow runs for this action?
    options:
      - if: New issue opened by Pierre-Mike
        then: issue-opened.yml → triage and assess confidence
      - if: Issue receives auto-implement or confidence label
        then: auto-implement.yml → create spec + draft PR
      - if: PR receives phase:* label (auto-implement branch)
        then: auto-implement-phases.yml → execute TDD phase
      - if: PR opened/updated (not draft)
        then: claude-code-review.yml → peer review
      - if: PR receives review:needs-work (auto-implement branch)
        then: review-fix.yml → fix review comments
      - if: PR opened/updated with client/server/shared changes
        then: deploy-preview.yml → create preview deployment
      - if: PR closed
        then: cleanup-preview.yml + auto-close-issues.yml (if merged)
      - if: Push to main/development
        then: ci.yml → run validation
      - if: Push to main with client/server/shared changes
        then: deploy-production.yml → production deployment
      - if: Comment contains @claude
        then: claude.yml → Claude Code response
      - if: Daily schedule or manual trigger
        then: workflow-smoke-test.yml → end-to-end test

  phase_progression:
    question: What is the auto-implement phase flow?
    flow: |
      1. Issue opened → issue-opened.yml → triage + assess
      2. auto-implement label applied → auto-implement.yml → create spec + draft PR
      3. phase:tests label → write tests (TDD red)
      4. phase:implement label → implement code (TDD green)
      5. phase:finalize label → update docs, mark PR ready
      6. phase:complete label → terminal state, ready for merge
      7. If any phase fails → phase:failed label, manual intervention required

  issue_type_selection:
    question: What is the primary outcome of this work?
    options:
      - if: Adds new capability visible to users
        then: feature (branch feat/*)
      - if: Fixes incorrect or broken behavior
        then: bug (branch bug/*)
      - if: Maintenance, deps, docs, or tooling
        then: chore (branch chore/*)
      - if: Restructures code without behavior change
        then: refactor (branch refactor/*)

  pr_validation_level:
    question: What type of changes does the PR contain?
    options:
      - if: Documentation-only, config, trivial fixes
        then: Level 1 (lint + typecheck)
      - if: Feature implementation, bug fixes, code changes
        then: Level 2 (lint + typecheck + integration tests)
      - if: Schema migration, breaking changes, releases
        then: Level 3 (full test suite + build)

# ─────────────────────────────────────────────────────────────────────────────
# CORE IMPLEMENTATION
# ─────────────────────────────────────────────────────────────────────────────
core_implementation:
  branch_naming:
    convention: "<type>/<issue-number>-<short-description>"
    types: [feat, bug, chore, refactor, docs, test]
    flow: "feature branch -> main"
    examples:
      - "feat/123-add-search-ranking"
      - "bug/456-fix-timeout"
      - "chore/789-update-dependencies"
    auto_implement_pattern: "issue-{number}-auto-implement"

  validation_levels:
    level_1:
      name: "Level 1 - Basic"
      when: "Docs-only, config, trivial fixes"
      checks: ["bun run lint", "bun run typecheck"]
    level_2:
      name: "Level 2 - Standard"
      when: "Features, bug fixes, code changes"
      checks: ["bun run lint", "bun run typecheck", "bun test --filter integration"]
    level_3:
      name: "Level 3 - Comprehensive"
      when: "Schema migrations, breaking changes, releases"
      checks: ["bun run lint", "bun run typecheck", "bun test", "bun run build"]

  key_files:
    issue_commands:
      - .claude/commands/triage-issue.md
      - .claude/commands/assess-confidence.md
      - .claude/commands/label-issue.md
    planning_commands:
      - .claude/commands/feature.md
      - .claude/commands/bug.md
      - .claude/commands/chore.md
    git_commands:
      - .claude/commands/git/commit.md
      - .claude/commands/git/pull_request.md
    workflows:
      - .github/workflows/*.yml
      - .github/setup-labels.sh

# ─────────────────────────────────────────────────────────────────────────────
# KEY OPERATIONS
# ─────────────────────────────────────────────────────────────────────────────
key_operations:
  create_pull_request:
    when: Implementation is complete and validated
    approach: |
      1. Verify working tree is clean, on correct branch
      2. Run validation at appropriate level
      3. Push: git push -u origin HEAD
      4. Create PR: gh pr create --base main --title "<title>" --body "<body>"

  commit_changes:
    format: "<type>(<scope>): <description>"
    types: [feat, fix, chore, refactor, docs, test, ci]
    examples:
      - "feat(api): add rate limiting to search endpoint"
      - "fix(indexer): resolve race condition"
      - "chore(deps): update bun to v1.2.0"

# ─────────────────────────────────────────────────────────────────────────────
# PATTERNS
# ─────────────────────────────────────────────────────────────────────────────
patterns:
  gh_cli:
    issues:
      - "gh issue create --title '<title>' --body '<body>'"
      - "gh issue edit <number> --add-label '<labels>'"
      - "gh issue view <number>"
      - "gh issue close <number>"
    prs:
      - "gh pr create --base main --title '<title>' --body '<body>'"
      - "gh pr view <number>"
      - "gh pr merge <number> --squash"
    labels:
      - "gh api repos/{owner}/{repo}/issues/<number>/labels --method POST -f 'labels[]=<label>'"
      - "gh api repos/{owner}/{repo}/issues/<number>/labels/<label> --method DELETE"

  pr_body_template: |
    ## Summary
    <1-3 bullet points describing changes>

    ## Validation Evidence
    - Validation Level: [1/2/3]
    - Commands Run: [pass/fail status]

    ## References
    - Closes #<issue_number>

# ─────────────────────────────────────────────────────────────────────────────
# BEST PRACTICES
# ─────────────────────────────────────────────────────────────────────────────
best_practices:
  issue_management:
    - Classify issues immediately upon creation
    - Apply type and confidence labels consistently
    - Use auto-implement for high/medium confidence issues
  pull_requests:
    - Run validation before creating PR
    - Target main branch
    - Squash merge for clean history
  commits:
    - Follow Conventional Commits format
    - Keep commits atomic and focused

# ─────────────────────────────────────────────────────────────────────────────
# KNOWN ISSUES
# ─────────────────────────────────────────────────────────────────────────────
known_issues:
  - issue: Phase label not triggering workflow
    impact: Auto-implement stalls
    resolution: Ensure label is applied via REST API, not gh issue edit
    status: operational guidance

  - issue: Review-fix loop exceeds 3 attempts
    impact: Manual intervention required
    resolution: Fix issues manually or break into smaller changes
    status: by design (prevents infinite loops)

  - issue: Draft PR skips peer review
    impact: Delays review until ready
    resolution: Mark PR ready for review when implementation complete
    status: by design

# ─────────────────────────────────────────────────────────────────────────────
# STABILITY
# ─────────────────────────────────────────────────────────────────────────────
stability:
  convergence_indicators:
    insight_rate_trend: stable
    contradiction_count: 0
    last_reviewed: 2026-02-03
    notes: |
      Major restructure: Added comprehensive pr_labels (29 labels), workflows (12),
      and CI/CD decision trees. Consolidated redundant content to stay under 800 lines.
