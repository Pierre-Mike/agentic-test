name: Auto Implement Issue

on:
  issues:
    types: [labeled]

jobs:
  auto-implement:
    if: |
      (github.event.label.name == 'auto-implement' || github.event.label.name == 'confidence:high' || github.event.label.name == 'confidence:medium') &&
      github.event.issue.user.login == 'Pierre-Mike' &&
      contains(github.event.issue.labels.*.name, 'auto-implement')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Auto Plan and Implement
        uses: anthropics/claude-code-action@main
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_PAT }}
          allowed_bots: '*'
          claude_args: '--allowedTools "Bash(gh:*),Bash(git:*),Bash(bun:*),Bash(npm:*),Edit,Write,Read,Glob,Grep,TodoWrite"'
          prompt: |
            You are automating the full development lifecycle from issue to pull request using structured planning.

            ISSUE INFORMATION:
            - Repository: ${{ github.repository }}
            - Issue Number: ${{ github.event.issue.number }}
            - Issue Title: ${{ github.event.issue.title }}
            - Issue URL: ${{ github.event.issue.html_url }}

            ## PHASE 1: ANALYZE THE ISSUE
            1. Read the issue: gh issue view ${{ github.event.issue.number }} --json title,body,labels
            2. Determine the issue type based on labels and content:
               - "bug" label or bug-related content â†’ BUG
               - "feature" or "enhancement" label â†’ FEATURE
               - "chore" or maintenance-related â†’ CHORE
               - Default to FEATURE if unclear

            ## PHASE 2: CREATE A PLAN
            Based on the issue type, read the appropriate planning template and create a plan:

            - For BUGS: Read .claude/commands/bug.md and create specs/bug-issue-${{ github.event.issue.number }}.md
            - For FEATURES: Read .claude/commands/feature.md and create specs/feature-issue-${{ github.event.issue.number }}.md
            - For CHORES: Read .claude/commands/chore.md and create specs/chore-issue-${{ github.event.issue.number }}.md

            Follow the exact Plan Format from the template. Research the codebase thoroughly before writing the plan.

            ## PHASE 3: IMPLEMENT THE PLAN
            Read .claude/commands/implement.md for implementation guidelines, then:
            1. Execute each step from your plan in order
            2. Follow existing patterns in the codebase
            3. Write clean, well-structured code
            4. Add tests as specified in the plan

            ## PHASE 4: VALIDATE
            Run the validation commands from your plan:
            - bun run test (if tests exist)
            - bun run build
            - bun run type-check

            ## PHASE 5: CREATE PULL REQUEST
            1. Configure git: git config user.name "github-actions[bot]" && git config user.email "github-actions[bot]@users.noreply.github.com"
            2. Create branch: git checkout -b issue-${{ github.event.issue.number }}-auto-implement
            3. Commit the plan file AND implementation: git add . && git commit -m "..."
            4. Push: git push -u origin issue-${{ github.event.issue.number }}-auto-implement
            5. Create PR with gh pr create, including:
               - Link to the plan file in specs/
               - Summary of changes
               - Validation results

            ## PHASE 6: LINK BACK
            Comment on the issue with the PR link and a summary.

            IMPORTANT:
            - The plan file (specs/*.md) should be committed with the implementation
            - If the issue is unclear, comment asking for clarification instead of implementing
            - Always validate before creating the PR

            Start by reading the issue details now.

      - name: Create PR if branch exists
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          BRANCH="issue-${{ github.event.issue.number }}-auto-implement"

          # Check if branch exists on remote
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "Branch $BRANCH exists, checking for existing PR..."

            # Check if PR already exists
            EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')

            if [ -z "$EXISTING_PR" ]; then
              echo "No existing PR found, creating one..."
              gh pr create \
                --head "$BRANCH" \
                --title "Closes #${{ github.event.issue.number }}: ${{ github.event.issue.title }}" \
                --body "## Summary

          Automated implementation for #${{ github.event.issue.number }}

          ## Changes
          See commits for details.

          ## Test Plan
          - [ ] Review the implementation
          - [ ] Run tests locally

          ---
          ðŸ¤– Auto-generated by Claude Code"

              echo "PR created successfully!"
            else
              echo "PR #$EXISTING_PR already exists for branch $BRANCH"
            fi
          else
            echo "Branch $BRANCH does not exist on remote, skipping PR creation"
          fi
