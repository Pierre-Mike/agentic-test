name: Auto Implement Issue

on:
  issues:
    types: [labeled]

concurrency:
  group: auto-implement-${{ github.event.issue.number }}
  cancel-in-progress: false

env:
  ISSUE_NUMBER: ${{ github.event.issue.number }}
  ISSUE_TITLE: ${{ github.event.issue.title }}
  ISSUE_URL: ${{ github.event.issue.html_url }}
  REPO: ${{ github.repository }}
  BRANCH: issue-${{ github.event.issue.number }}-auto-implement

jobs:
  # â”€â”€ Plan + Create Draft PR â”€â”€
  analyze-and-plan:
    if: |
      (github.event.label.name == 'auto-implement' || github.event.label.name == 'confidence:high' || github.event.label.name == 'confidence:medium') &&
      github.event.issue.user.login == 'Pierre-Mike' &&
      contains(github.event.issue.labels.*.name, 'auto-implement')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          token: ${{ secrets.GH_PAT }}

      - name: Setup git & branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"

      - name: "Phase 1-2: Analyze & Plan"
        uses: anthropics/claude-code-action@main
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GH_PAT }}
          allowed_bots: '*'
          claude_args: '--allowedTools "Bash(gh:*),Bash(git:*),Bash(bun:*),Read,Write,Glob,Grep"'
          prompt: |
            You are in Phase 1-2 of auto-implementation for issue #${{ env.ISSUE_NUMBER }}.

            PHASE 1: ANALYZE THE ISSUE
            1. Read the issue: gh issue view ${{ env.ISSUE_NUMBER }} --json title,body,labels
            2. Determine the issue type:
               - "bug" label or bug-related content â†’ BUG
               - "feature" or "enhancement" label â†’ FEATURE
               - "chore" or maintenance-related â†’ CHORE
               - Default to FEATURE if unclear

            PHASE 2: CREATE A PLAN
            Based on the issue type, read the appropriate planning template and create a plan:
            - For BUGS: Read .claude/commands/bug.md and create specs/bug-issue-${{ env.ISSUE_NUMBER }}.md
            - For FEATURES: Read .claude/commands/feature.md and create specs/feature-issue-${{ env.ISSUE_NUMBER }}.md
            - For CHORES: Read .claude/commands/chore.md and create specs/chore-issue-${{ env.ISSUE_NUMBER }}.md

            Follow the exact Plan Format from the template. Research the codebase thoroughly before writing the plan.
            The plan must include: e2e tests, unit tests, implementation steps, and doc updates.

            Then commit and push:
            git add specs/ && git commit --no-verify -m "plan: add spec for #${{ env.ISSUE_NUMBER }}"
            git push -u origin "$BRANCH" --no-verify

            IMPORTANT: Only commit the spec file. Do not write any code or tests yet.

      - name: Create draft PR
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')

          if [ -z "$EXISTING_PR" ]; then
            SPEC_FILE=$(ls specs/*-issue-${ISSUE_NUMBER}.md 2>/dev/null | head -1)
            SPEC_LINK=""
            if [ -n "$SPEC_FILE" ]; then
              SPEC_LINK="- [Spec file]($SPEC_FILE)"
            fi

            gh pr create \
              --head "$BRANCH" \
              --draft \
              --title "Closes #${ISSUE_NUMBER}: ${ISSUE_TITLE}" \
              --body "$(cat <<EOF
          ## Summary

          Automated TDD implementation for #${ISSUE_NUMBER}

          ## Phase Progress
          - [x] Plan & spec
          - [ ] Write tests (TDD red)
          - [ ] Implement + validate (TDD green)
          - [ ] Finalize & mark ready

          ## Commits
          - \`plan:\` spec file
          - \`test:\` tests written first (TDD)
          - \`feat/fix:\` implementation to pass tests
          - \`docs:\` documentation updates (if any)

          ## References
          - Issue: #${ISSUE_NUMBER}
          ${SPEC_LINK}

          ---
          ðŸ¤– Auto-generated by Claude Code
          EOF
          )"

            # Add label separately via REST API to trigger the pull_request labeled event
            NEW_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')
            gh api repos/${{ github.repository }}/issues/${NEW_PR}/labels --method POST -f "labels[]=phase:tests"
            echo "Draft PR created, phase:tests label applied"
          else
            echo "PR #$EXISTING_PR already exists for branch $BRANCH"
            # Ensure phase:tests label is applied
            gh api repos/${{ github.repository }}/issues/${EXISTING_PR}/labels --method POST -f "labels[]=phase:tests"
          fi

      - name: Comment on issue
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_URL=$(gh pr list --head "$BRANCH" --json url --jq '.[0].url')
          if [ -n "$PR_URL" ]; then
            gh issue comment "$ISSUE_NUMBER" --body "ðŸ¤– Draft PR created: $PR_URL â€” phases will run automatically via labels."
          fi
