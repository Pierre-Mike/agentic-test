name: Issue Triage with Claude

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Triage Issue with Claude
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are an issue triage assistant for a TypeScript monorepo project (client/server/shared architecture).

            Analyze this GitHub issue and perform the following actions:

            1. Determine the appropriate labels based on these rules:
               - Category: bug, feature, enhancement, documentation, or question
               - Priority: priority:critical, priority:high, priority:medium, or priority:low
               - Area: area:client, area:server, area:shared, or area:infrastructure
               - Add "good-first-issue" if the issue seems simple and well-defined
               - Add "needs-investigation" if more information is needed
               - Add "security" if security-related
               - Add "performance" if performance-related

            2. Apply the labels to issue #${{ github.event.issue.number }} using the gh CLI:
               gh issue edit ${{ github.event.issue.number }} --add-label "label1,label2,..."

            3. Add a comment to the issue with your triage analysis in this format:

               ## Automated Issue Triage

               | Field | Value |
               |-------|-------|
               | **Category** | <category> |
               | **Priority** | <priority> |
               | **Area** | <area> |

               ### Summary
               <one sentence summary of the issue>

               ### Recommended Next Steps
               1. <step 1>
               2. <step 2>

               ---
               *This triage was performed automatically by Claude.*

            Issue Title: ${{ github.event.issue.title }}

            Issue Body:
            ${{ github.event.issue.body }}
          allowed_tools: |
            Bash(gh issue:*)
            Bash(gh label:*)
